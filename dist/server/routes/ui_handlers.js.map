{"version":3,"sources":["../../../src/server/routes/ui_handlers.js"],"names":["db","handleError","req","rep","error","console","log","makeCookie","id","username","scope","validateLogin","rows","length","compare","payload","password","toString","then","isValid","Promise","reject","Error","onLoginValidated","userData","cookieAuth","set","redirect","login","method","auth","isAuthenticated","view","catch","undefined","register","home","credentials","indexOf","logout","clear","admin"],"mappings":"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","file":"ui_handlers.js","sourcesContent":["import bcrypt from 'bcrypt';\nimport * as db from '../db/';\n\nexport const handleError = (req, rep) => (error) => {\n  console.log('from handleError......', error);\n  return rep(error);\n};\n\nexport const makeCookie = ({ id, username }) => ({\n  id,\n  username,\n  scope: username === 'wales-coop' ? ['admin'] : ['user'],\n});\n\nexport const validateLogin = payload => ({ rows }) => (\n  rows.length\n  ? bcrypt.compare(payload.password, rows[0].password.toString('utf-8'))\n  .then(isValid =>\n      (isValid\n        ? rows[0]\n        : Promise.reject(new Error('Invalid login details'))))\n    : Promise.reject(new Error('Invalid login details'))\n);\n\nexport const onLoginValidated = (req, rep) => (userData) => {\n  req.cookieAuth.set(makeCookie(userData));\n  return rep.redirect('/');\n};\n\nexport const login = (req, rep) => {\n  if (req.method === 'get') {\n    if (req.auth.isAuthenticated) return rep.redirect('/');\n    return rep.view('login');\n  }\n  if (req.method === 'post') {\n    db.login(req.payload)\n      .then(validateLogin(req.payload))\n      .then(onLoginValidated(req, rep))\n      .catch(handleError(req, rep));\n  }\n  return undefined;\n};\n\nexport const register = (req, rep) => {\n  if (req.auth.isAuthenticated) return rep.redirect('/');\n  return rep.view('register');\n};\n\nexport const home = (req, rep) => {\n  if (req.auth.credentials.scope.indexOf('user') > -1) {\n    return rep.view('home', {\n      username: req.auth.credentials.username,\n    });\n  } else if (req.auth.credentials.scope.indexOf('admin') > -1) {\n    return rep.redirect('/admin');\n  }\n  return undefined;\n};\n\nexport const logout = (req, rep) => {\n  req.cookieAuth.clear();\n  rep.redirect('/login');\n};\n\nexport const admin = (req, rep) => {\n  rep.view('admin', {\n    username: req.auth.credentials.username,\n  });\n};\n"]}