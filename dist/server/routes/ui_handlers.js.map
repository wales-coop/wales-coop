{"version":3,"sources":["../../../src/server/routes/ui_handlers.js"],"names":["db","handleError","req","rep","error","console","log","makeCookie","id","username","scope","validateLogin","rows","length","compare","payload","password","then","isValid","Promise","reject","Error","onLoginValidated","userData","cookieAuth","set","redirect","login","method","auth","isAuthenticated","view","catch","undefined","register","home","credentials","indexOf","logout","clear","admin"],"mappings":"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","file":"ui_handlers.js","sourcesContent":["import Bcrypt from 'bcrypt';\nimport * as db from '../db/';\n\nexport const handleError = (req, rep) => (error) => {\n  console.log('from handleError......', error);\n  return rep(error);\n};\n\nexport const makeCookie = ({ id, username }) => ({\n  id,\n  username,\n  scope: username === 'wales-coop' ? ['admin'] : ['user'],\n});\n\nexport const validateLogin = payload => ({ rows }) => (\n  rows.length\n    ? Bcrypt.compare(payload.password, rows[0].password)\n    .then(isValid => (\n      isValid\n      ? rows[0]\n      : Promise.reject(new Error('Invalid login details'))\n    ))\n  : Promise.reject(new Error('Invalid login details'))\n);\n\nexport const onLoginValidated = (req, rep) => (userData) => {\n  req.cookieAuth.set(makeCookie(userData));\n  return rep.redirect('/');\n};\n\nexport const login = (req, rep) => {\n  if (req.method === 'get') {\n    if (req.auth.isAuthenticated) return rep.redirect('/');\n    return rep.view('login');\n  }\n  if (req.method === 'post') {\n    db.login(req.payload)\n      .then(validateLogin(req.payload))\n      .then(onLoginValidated(req, rep))\n      .catch(handleError(req, rep));\n  }\n  return undefined;\n};\n\nexport const register = (req, rep) => {\n  if (req.auth.isAuthenticated) return rep.redirect('/');\n  return rep.view('register');\n};\n\nexport const home = (req, rep) => {\n  if (req.auth.credentials.scope.indexOf('user') > -1) {\n    return rep.view('home', {\n      username: req.auth.credentials.username,\n    });\n  } else if (req.auth.credentials.scope.indexOf('admin') > -1) {\n    return rep.redirect('/admin');\n  }\n  return undefined;\n};\n\nexport const logout = (req, rep) => {\n  req.cookieAuth.clear();\n  rep.redirect('/login');\n};\n\nexport const admin = (req, rep) => {\n  rep.view('admin', {\n    username: req.auth.credentials.username,\n  });\n};\n"]}